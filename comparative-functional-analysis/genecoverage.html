<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Determine gene coverage in metagenomic samples &mdash; Metagenomics Workshop SciLifeLab 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Metagenomics Workshop SciLifeLab 1.0 documentation" href="../index.html" />
    <link rel="up" title="Comparative Functional Analysis Workshop" href="index.html" />
    <link rel="next" title="Comparative functional analysis with R" href="compare.html" />
    <link rel="prev" title="Functional annotation" href="annotation.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="compare.html" title="Comparative functional analysis with R"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="annotation.html" title="Functional annotation"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Metagenomics Workshop SciLifeLab 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Comparative Functional Analysis Workshop</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="determine-gene-coverage-in-metagenomic-samples">
<h1>Determine gene coverage in metagenomic samples<a class="headerlink" href="#determine-gene-coverage-in-metagenomic-samples" title="Permalink to this headline">Â¶</a></h1>
<p>Ok, now that we know what functions are represented in the combined samples (we
could call it the Baltic meta-community, i.e. a community of communities), we
may want to know how much of the different functions (COG families and classes)
are present in the different samples, since this will likely change between
seasons. To do this we first map the reads from the different samples against
the contigs. We will use the mapping script that we used this morning. First
create a directory and cd there:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir -p ~/metagenomics/cfa/map
cd ~/metagenomics/cfa/map
</pre></div>
</div>
<p>Copy the contig file and build an index on it for bowtie2:</p>
<div class="highlight-python"><div class="highlight"><pre>cp /proj/g2014113/metagenomics/cfa/assembly/baltic-sea-ray-noscaf-41.1000.fa .
bowtie2-build baltic-sea-ray-noscaf-41.1000.fa baltic-sea-ray-noscaf-41.1000.fa
</pre></div>
</div>
<p>You will end up with various baltic-sea-ray-noscaf-41.1000.fa.*.bt2 files that
represent the index for the assembly. It allows for faster alignment of
sequences, see <a class="reference external" href="http://en.wikipedia.org/wiki/Burrows%E2%80%93Wheeler_transform">http://en.wikipedia.org/wiki/Burrows%E2%80%93Wheeler_transform</a>
for more information.</p>
<p>Now we will use some crazy bash for loop to map all the reads. This actually
prints the mapping command instead of executing, because it takes too much time
to run it, it does however create the directories:</p>
<div class="highlight-python"><div class="highlight"><pre>for s in /proj/g2014113/metagenomics/cfa/reads/*_R1.fastq.gz; do
    echo mkdir -p $(basename $s _R1.fastq.gz)
    echo cd $(basename $s _R1.fastq.gz)
    echo map-bowtie2-markduplicates.sh -ct 1 \
        $s ${s/R1/R2} pair \
        ~/metagenomics/cfa/map/baltic-sea-ray-noscaf-41.1000.fa asm \
        bowtie2
    echo cd ..
done
</pre></div>
</div>
<p>The for loop iterates over all the first mates of the pairs. It then creates a
directory using the basename of the pair with the directory part and the
postfix removed, goes to that dir and runs <tt class="docutils literal"><span class="pre">map-bowtie2-markduplicates.sh</span></tt> on
both mates of the pair. Try to change the for loop such that it only maps one
sample.</p>
<p><strong>Question: Can you think of an easy way to parallelize this?</strong>
.. Add an &amp; after bowtie2</p>
<blockquote>
<div>For more examples on how to parallelize this check: <a class="reference external" href="http://bit.ly/gwbash">http://bit.ly/gwbash</a></div></blockquote>
<p>If you sort of understand what&#8217;s going on in the for loop above you are welcome
to copy the data that we have already generated:</p>
<div class="highlight-python"><div class="highlight"><pre>cp -r /proj/g2014113/metagenomics/cfa/map/* ~/metagenomics/cfa/map/
</pre></div>
</div>
<p>Take a look at the files that have been created. Check
<tt class="docutils literal"><span class="pre">map-bowtie2-markduplicates.sh</span> <span class="pre">-h</span></tt> for an explanation of the different files.</p>
<p><strong>Question what is the mean coverage for contig-394 in sample 0328?</strong></p>
<p>Next we want to figure out the coverage for every gene in every contig per
sample. We will use the bedtools coverage command within the BEDTools suite
(<a class="reference external" href="https://code.google.com/p/bedtools/">https://code.google.com/p/bedtools/</a>) that can parse a SAM/BAM file and a gff
file to extract coverage information for every gene:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir -p ~/metagenomics/cfa/coverage-hist-per-feature-per-sample
cd ~/metagenomics/cfa/coverage-hist-per-feature-per-sample
</pre></div>
</div>
<p>Run bedtools coverage on one sample (~4m):</p>
<div class="highlight-python"><div class="highlight"><pre>for s in 0328; do
    bedtools coverage -hist -abam ~/metagenomics/cfa/map/$s/bowtie2/asm_pair-smds.bam \
        -b ../prodigal/baltic-sea-ray-noscaf-41.1000.gff \
        &gt; $s-baltic-sea-ray-noscaf-41.1000.gff.coverage.hist
done
</pre></div>
</div>
<p>Copy the other ones:</p>
<div class="highlight-python"><div class="highlight"><pre>cp /proj/g2014113/metagenomics/cfa/map/coverage-hist-per-feature-per-sample/* .
</pre></div>
</div>
<p>Have a look at which files have been created with less again. The final four
columns give you the histogram i.e. coverage, number of bases with that
coverage, length of the contig/feature/gene, bases with that coverage expressed
as a ratio of the length of the contig/feature/gene.</p>
<p>Now what we want to is do is to extract the mean coverage per COG instead of
per gene. Remember that multiple genes can belong to the same COG so we will
take the sum of the mean coverage from those genes. We will use the script
<tt class="docutils literal"><span class="pre">br-sum-mean-cov-per-cog.py</span></tt> for that. First make a directory
again and go there:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir -p ~/metagenomics/cfa/cog-sum-mean-cov
cd ~/metagenomics/cfa/cog-sum-mean-cov
</pre></div>
</div>
<p>The script expects a file with one samplename per line so we will create an
array with those sample names
(<a class="reference external" href="http://www.thegeekstuff.com/2010/06/bash-array-tutorial/">http://www.thegeekstuff.com/2010/06/bash-array-tutorial/</a>):</p>
<div class="highlight-python"><div class="highlight"><pre>samplenames=(0328 0403 0423 0531 0619 0705 0709 1001 1004 1028 1123)
echo ${samplenames[*]}
</pre></div>
</div>
<p>Now we can use process substitution to give the script those sample names
without having to store it to a file first.</p>
<p><strong>Question: What is the difference between the following statements?</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre>echo ${samplenames[*]}
cat &lt;(echo ${samplenames[*]})
cat &lt;(echo ${samplenames[*]} | tr &#39; &#39; &#39;\n&#39;)
</pre></div>
</div>
<p>Run the the script that computes the sum of mean coverages per COG (~2m47):</p>
<div class="highlight-python"><div class="highlight"><pre>br-sum-mean-cov-per-cog.py --samplenames &lt;(echo ${samplenames[*]} | tr &#39; &#39; &#39;\n&#39;) \
    ../prodigal/baltic-sea-ray-noscaf-41.1000.gff ../prodigal/baltic-sea-ray-noscaf-41.1000.aa.fa \
    ../wmga-cog/output.2 ../coverage-hist-per-feature-per-sample/*.gff.coverage.hist \
    &gt; cog-sum-mean-cov.tsv
</pre></div>
</div>
<p>Have a look at the table with less -S again.</p>
<p><strong>Question: What is the sum of mean coverages for COG0038 in sample 0423?</strong></p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="annotation.html"
                        title="previous chapter">Functional annotation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="compare.html"
                        title="next chapter">Comparative functional analysis with R</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/comparative-functional-analysis/genecoverage.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="compare.html" title="Comparative functional analysis with R"
             >next</a> |</li>
        <li class="right" >
          <a href="annotation.html" title="Functional annotation"
             >previous</a> |</li>
        <li><a href="../index.html">Metagenomics Workshop SciLifeLab 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Comparative Functional Analysis Workshop</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Johannes Alneberg, Johan Bengtsson-Palme, Ino de Bruijn, Luisa Hugerth, Mikael Huss, Thomas Svensson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>